<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lucky Wheel | Smokin174</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;900&display=swap');
        :root { --bg-black: #000000; --neon-green: #2bff00; --transition: all 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: radial-gradient(circle at center, #0a1a05 0%, #000 100%); color: #fff; min-height: 100vh; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        
        .header { width: 100%; display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .back-btn { color: #fff; text-decoration: none; font-weight: 900; font-size: 0.9rem; text-transform: uppercase; border: 1px solid rgba(255,255,255,0.2); padding: 10px 20px; border-radius: 50px; }

        .balance-display { text-align: center; }
        .balance-amount { color: var(--neon-green); font-weight: 900; font-size: 1.1rem; }

        .tier-selector { display: flex; gap: 10px; margin-bottom: 30px; width: 100%; max-width: 500px; }
        .tier-btn { flex: 1; padding: 15px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: #fff; font-weight: 900; cursor: pointer; transition: 0.3s; }
        .tier-btn.active { background: var(--neon-green); color: #000; border-color: var(--neon-green); box-shadow: 0 0 20px rgba(43, 255, 0, 0.4); }

        .slot-window { position: relative; width: 100%; max-width: 400px; height: 160px; background: rgba(0,0,0,0.8); border-radius: 30px; border: 2px solid rgba(255,255,255,0.1); overflow: hidden; margin-bottom: 30px; }
        .slot-track { position: absolute; top: 0; left: 0; width: 100%; }
        .slot-item { height: 160px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: 900; text-transform: uppercase; text-align: center; padding: 0 10px; }
        
        .arrow { position: absolute; top: 50%; transform: translateY(-50%); width: 0; height: 0; border-top: 15px solid transparent; border-bottom: 15px solid transparent; z-index: 10; filter: drop-shadow(0 0 8px var(--neon-green)); }
        .arrow-left { left: 10px; border-left: 20px solid var(--neon-green); }
        .arrow-right { right: 10px; border-right: 20px solid var(--neon-green); }

        .btn-pay { width: 100%; max-width: 400px; background: var(--neon-green); color: #000; border: none; padding: 20px; border-radius: 50px; font-weight: 900; font-size: 1rem; text-transform: uppercase; cursor: pointer; margin-bottom: 15px; box-shadow: 0 10px 30px rgba(43,255,0,0.3); transition: 0.3s; }
        .btn-pay:disabled { opacity: 0.5; filter: grayscale(1); }
        
        .btn-stars { background: #0088cc; color: white; margin-top: 10px; }

        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); display: none; align-items: center; justify-content: center; z-index: 2000; padding: 20px; }
        .modal { background: rgba(20,20,20,0.9); border: 1px solid rgba(255,255,255,0.1); border-radius: 40px; padding: 30px; width: 100%; max-width: 400px; text-align: center; }
        .active { display: flex; }
    </style>
</head>
<body>
    <div class="header">
        <a href="index.html" class="back-btn"><i class="fas fa-arrow-left"></i></a>
        <div class="balance-display">
            <div style="font-weight: 900; font-size: 0.7rem; opacity: 0.6;">ВАШ БАЛАНС</div>
            <div id="userBalance" class="balance-amount">0 ₽</div>
        </div>
        <div style="width: 45px;"></div>
    </div>

    <div class="tier-selector">
        <button class="tier-btn active" onclick="selectTier(10)">10 ₽</button>
        <button class="tier-btn" onclick="selectTier(50)">50 ₽</button>
        <button class="tier-btn" onclick="selectTier(150)">150 ₽</button>
    </div>

    <div class="slot-window">
        <div class="arrow arrow-left"></div>
        <div class="arrow arrow-right"></div>
        <div class="slot-track" id="slotTrack"></div>
    </div>

    <div id="statusText" style="margin-bottom: 20px; font-weight: 900; color: var(--neon-green); min-height: 1.2em;"></div>

    <button class="btn-pay" id="mainBtn" onclick="handleAction()">ЗАГРУЗКА...</button>

    <div class="overlay" id="payMethodOverlay" onclick="this.classList.remove('active')">
        <div class="modal" onclick="event.stopPropagation()">
            <h2 style="margin-bottom:20px;">ВЫБОР ОПЛАТЫ</h2>
            <button class="btn-pay btn-stars" onclick="payWithStars()">
                <i class="fab fa-telegram"></i> ОПЛАТИТЬ STARS
            </button>
            <button class="btn-pay" style="background:#fff;" onclick="openSBP()">
                <i class="fas fa-university"></i> ПЕРЕВОД СБП (РУБ)
            </button>
        </div>
    </div>

    <div class="overlay" id="sbpOverlay" onclick="this.classList.remove('active')">
        <div class="modal" onclick="event.stopPropagation()">
            <h2 style="margin-bottom:20px;">ОПЛАТА СБП</h2>
            <div id="qrContainer" style="background:#fff; padding:15px; border-radius:20px; display:inline-block; margin-bottom:20px;"></div>
            <p id="sbpInstructions" style="font-size:0.9rem; margin-bottom:20px; opacity:0.8;"></p>
            <button class="btn-pay" onclick="confirmPayment()">Я ОПЛАТИЛ</button>
        </div>
    </div>

<script>
    const tg = window.Telegram.WebApp;
    const firebaseConfig = {
        apiKey: "AIzaSyD3wDw2ZTTXn2gY467grDOVi9E5vcusilc",
        authDomain: "alexsmok-1dc1c.firebaseapp.com",
        databaseURL: "https://alexsmok-1dc1c-default-rtdb.firebaseio.com",
        projectId: "alexsmok-1dc1c",
        appId: "1:173792761960:web:5bc84d324322edd58ac3dd"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    const user = tg.initDataUnsafe?.user || { id: 'test_user', username: 'local_user' };
    let currentTier = 10;
    let configs = {};
    let canSpin = false;
    let userBalance = 0;
    let sbpReceiver = "";

    function loadConfigs() {
        db.ref('settings/wheel_v2').on('value', snap => {
            configs = snap.val() || { t10: [{name: "ПУСТО", chance: 100}], t50: [{name: "ПУСТО", chance: 100}], t150: [{name: "ПУСТО", chance: 100}] };
            updateUI();
        });
        db.ref('settings/sbp_receiver').on('value', snap => { sbpReceiver = snap.val() || "Не указан"; });
        
        // Слушаем баланс
        db.ref(`users/${user.id}/balance`).on('value', snap => {
            userBalance = snap.val() || 0;
            document.getElementById('userBalance').innerText = `${userBalance} ₽`;
            updateButton();
        });

        // Слушаем наличие оплаченного спина
        db.ref(`users/${user.id}/spins/${currentTier}`).on('value', snap => {
            canSpin = !!snap.val();
            updateButton();
        });
    }

    function selectTier(t) {
        currentTier = t;
        document.querySelectorAll('.tier-btn').forEach(b => {
            b.classList.toggle('active', b.innerText.includes(t));
        });
        db.ref(`users/${user.id}/spins/${currentTier}`).off(); // Сброс старого слушателя
        db.ref(`users/${user.id}/spins/${currentTier}`).on('value', snap => {
            canSpin = !!snap.val();
            updateButton();
        });
        updateUI();
    }

    function updateUI() {
        const track = document.getElementById('slotTrack');
        const list = configs['t' + currentTier] || [{name: "...", chance: 100}];
        let h = '';
        for(let i=0; i<60; i++) {
            h += `<div class="slot-item">${list[i % list.length].name}</div>`;
        }
        track.innerHTML = h;
        track.style.transition = 'none';
        track.style.transform = 'translateY(0)';
    }

    function updateButton() {
        const btn = document.getElementById('mainBtn');
        if (canSpin) {
            btn.innerText = "КРУТИТЬ БЕСПЛАТНО";
            btn.style.background = "var(--neon-green)";
        } else if (userBalance >= currentTier) {
            btn.innerText = `ИГРАТЬ (СПИСАТЬ ${currentTier} ₽)`;
            btn.style.background = "var(--neon-green)";
        } else {
            btn.innerText = `ПОПОЛНИТЬ БАЛАНС`;
            btn.style.background = "#fff";
        }
    }

    async function handleAction() {
        if (canSpin) {
            runSpin();
        } else if (userBalance >= currentTier) {
            if(confirm(`Списать ${currentTier} ₽ с баланса и начать игру?`)) {
                await db.ref(`users/${user.id}/balance`).set(userBalance - currentTier);
                await db.ref(`users/${user.id}/spins/${currentTier}`).set(true);
            }
        } else {
            document.getElementById('payMethodOverlay').classList.add('active');
        }
    }

    function openSBP() {
        document.getElementById('payMethodOverlay').classList.remove('active');
        const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent("https://qr.nspk.ru/...")}`;
        document.getElementById('qrContainer').innerHTML = `<img src="${qrUrl}">`;
        document.getElementById('sbpInstructions').innerText = `Переведите ${currentTier}₽ на номер: ${sbpReceiver}. После проверки баланс будет пополнен.`;
        document.getElementById('sbpOverlay').classList.add('active');
    }

    async function payWithStars() {
        document.getElementById('payMethodOverlay').classList.remove('active');
        try {
            // Запрашиваем инвойс у твоего сервера Vercel
            const resp = await fetch(`https://твой-сервер.vercel.app/api/getInvoice?userId=${user.id}`);
            const data = await resp.json();
            if(data.link) {
                tg.openInvoice(data.link, (status) => {
                    if(status === 'paid') tg.showAlert("Оплата успешно завершена!");
                });
            }
        } catch(e) { tg.showAlert("Ошибка связи с сервером"); }
    }

    function confirmPayment() {
        tg.showAlert("Запрос на проверку отправлен администратору!");
        document.getElementById('sbpOverlay').classList.remove('active');
        // Логика: создаем заявку в БД для админа
        db.ref('admin/payment_requests').push({ uid: user.id, amount: currentTier, type: 'SBP', date: Date.now() });
    }

    function runSpin() {
        const btn = document.getElementById('mainBtn');
        const track = document.getElementById('slotTrack');
        const status = document.getElementById('statusText');
        btn.disabled = true;
        
        const tierList = configs['t' + currentTier];
        let totalWeight = tierList.reduce((s, i) => s + i.chance, 0);
        let rnd = Math.random() * totalWeight;
        let sum = 0;
        let win = tierList[0].name;
        
        for (let item of tierList) {
            sum += item.chance;
            if (rnd <= sum) { win = item.name; break; }
        }

        const winIdx = 45;
        track.children[winIdx].innerText = win;
        track.style.transition = 'transform 5s cubic-bezier(0.1, 0, 0.1, 1)';
        track.style.transform = `translateY(-${winIdx * 160}px)`;

        setTimeout(async () => {
            status.innerText = win.includes("ПУСТО") ? "ПОПРОБУЙ ЕЩЕ РАЗ!" : `ВЫИГРЫШ: ${win}`;
            btn.disabled = false;
            
            await db.ref('logs/wheel_spins').push({
                uid: user.id, username: user.username || "unknown",
                tier: currentTier, prize: win, date: firebase.database.ServerValue.TIMESTAMP
            });

            db.ref(`users/${user.id}/spins/${currentTier}`).set(false);
            tg.HapticFeedback.notificationOccurred(win.includes("ПУСТО") ? 'error' : 'success');
        }, 5200);
    }

    loadConfigs();
    tg.expand();
</script>
</body>
</html>
