<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Прайс | Smokin174</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;900&display=swap');
        :root {
            --bg-black: #000000;
            --neon-green: #2bff00;
            --transition: all 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg-black); color: #fff; overflow-x: hidden; }
        
        #bg-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
        
        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        header { position: sticky; top: 0; z-index: 1000; padding: 1rem 0; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
        .header-content { display: flex; justify-content: space-between; align-items: center; max-width: 1400px; margin: 0 auto; padding: 0 20px; }
        .logo-text { font-weight: 900; font-size: 1.5rem; text-transform: uppercase; }
        
        .user-balance-box { display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.1); padding: 5px 12px; border-radius: 50px; cursor: pointer; }
        .balance-val { color: var(--neon-green); font-weight: 900; }

        .cat-bar { padding: 15px 0; overflow-x: auto; scrollbar-width: none; }
        .cat-container { display: flex; gap: 10px; padding: 0 20px; }
        .cat-link { padding: 10px 20px; border-radius: 50px; font-weight: 900; font-size: 0.75rem; cursor: pointer; white-space: nowrap; border: 1px solid rgba(255,255,255,0.1); }
        .cat-link.active { background: var(--neon-green); color: #000; }
        
        .main { padding: 0 15px 100px; }
        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        
        .card { border-radius: 20px; overflow: hidden; display: flex; flex-direction: column; position: relative; }
        .card-img { width: 100%; height: 150px; object-fit: cover; }
        .card-info { padding: 12px; }
        .card-name { font-weight: 900; font-size: 0.8rem; margin-bottom: 5px; }
        .card-price { color: var(--neon-green); font-weight: 900; }
        
        /* Исправленные кнопки iOS */
        .btn-buy, .btn-variant { 
            -webkit-appearance: none; 
            width: 100%; padding: 12px; border-radius: 12px; border: none; font-weight: 900; text-transform: uppercase; font-size: 0.7rem; margin-top: 10px; cursor: pointer;
            display: inline-block; text-align: center;
        }
        .btn-buy { background: var(--neon-green); color: #000; }
        .btn-variant { background: rgba(255,255,255,0.1); color: #fff; }

        /* Модалки */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 2000; display: none; align-items: center; justify-content: center; opacity: 0; transition: 0.3s; }
        .overlay.active { display: flex; opacity: 1; }
        .modal { width: 90%; max-width: 450px; border-radius: 30px; padding: 20px; position: relative; max-height: 90vh; overflow-y: auto; }

        /* Колесо (оригинальный вид) */
        .wheel-box { position: relative; width: 100%; height: 150px; background: #111; border: 2px solid var(--neon-green); border-radius: 20px; overflow: hidden; margin: 20px 0; }
        .wheel-track { position: absolute; top: 0; display: flex; flex-direction: column; width: 100%; }
        .wheel-item { height: 150px; display: flex; align-items: center; justify-content: center; font-weight: 900; text-align: center; font-size: 1.2rem; }

        /* Админка */
        .admin-inp { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 12px; border: 1px solid #333; background: #111; color: #fff; }
        .admin-btn-red { background: #ff4444; color: #fff; padding: 10px; border-radius: 10px; border: none; width: 100%; font-weight: 900; margin-top: 10px; }

        .cart-fab { position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; background: var(--neon-green); border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 1500; color: #000; display: none; }
    </style>
</head>
<body>
<canvas id="bg-canvas"></canvas>

<header>
    <div class="header-content">
        <div class="logo-text">ПРАЙС</div>
        <div style="display: flex; gap: 15px; align-items: center;">
            <div class="user-balance-box" onclick="openModal('walletOverlay')">
                <i class="fas fa-wallet" style="color:var(--neon-green)"></i>
                <span id="hBal" class="balance-val">0 ₽</span>
            </div>
            <i class="fas fa-gift fa-lg" onclick="openWheel()"></i>
            <i class="fas fa-user-shield fa-lg" id="adminLock" onclick="adminAuth()"></i>
        </div>
    </div>
</header>

<div class="cat-bar"><div class="cat-container" id="cats"></div></div>
<main class="main"><div class="grid" id="grid"></div></main>

<div class="overlay" id="walletOverlay" onclick="closeModal('walletOverlay')">
    <div class="modal glass" onclick="event.stopPropagation()">
        <h2 style="margin-bottom:15px; font-weight:900;">КОШЕЛЕК</h2>
        <div style="background:rgba(0,0,0,0.3); padding:20px; border-radius:20px; margin-bottom:20px; border:1px solid var(--neon-green)">
            <small>БАЛАНС:</small>
            <div style="font-size:2.5rem; font-weight:900; color:var(--neon-green)" id="mBal">0 ₽</div>
        </div>
        
        <p style="margin-bottom:10px; font-size:0.8rem; opacity:0.7;">ПОПОЛНЕНИЕ:</p>
        <button class="btn-buy" style="background:#0088cc; color:#fff; margin-bottom:10px;" onclick="payStars()">⭐ ТЕЛЕГРАМ ЗВЕЗДЫ</button>
        <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:15px;">
            <p style="font-weight:900; font-size:0.9rem; margin-bottom:5px;">СБП / КАРТА</p>
            <div id="paymentDetails" style="font-size:0.8rem; margin-bottom:10px; color:var(--neon-green)">Загрузка реквизитов...</div>
            <button class="btn-variant" onclick="confirmSBP()">Я ОПЛАТИЛ (ЧЕК)</button>
        </div>
    </div>
</div>

<div class="overlay" id="wheelOverlay" onclick="closeModal('wheelOverlay')">
    <div class="modal glass" onclick="event.stopPropagation()">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
            <button class="cat-link active" id="btn10" onclick="setWheelTier(10)">10 ₽</button>
            <button class="cat-link" id="btn50" onclick="setWheelTier(50)">50 ₽</button>
            <button class="cat-link" id="btn150" onclick="setWheelTier(150)">150 ₽</button>
        </div>
        <div class="wheel-box">
            <div style="position:absolute; top:50%; left:0; width:100%; height:2px; background:var(--neon-green); z-index:10; transform:translateY(-50%);"></div>
            <div class="wheel-track" id="wheelTrack"></div>
        </div>
        <button class="btn-buy" id="spinBtn" onclick="startSpin()">ИСПЫТАТЬ УДАЧУ</button>
        <div id="wheelRes" style="margin-top:15px; text-align:center; font-weight:900;"></div>
    </div>
</div>

<div class="cart-fab" id="cartFab" onclick="openModal('cartOverlay')">
    <i class="fas fa-shopping-basket"></i>
    <span id="cartCount" style="position:absolute; top:-5px; right:-5px; background:red; color:#fff; font-size:10px; padding:2px 6px; border-radius:10px;">0</span>
</div>

<div class="overlay" id="cartOverlay" onclick="closeModal('cartOverlay')">
    <div class="modal glass" onclick="event.stopPropagation()">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 style="font-weight:900;">КОРЗИНА</h2>
            <button onclick="clearCart()" style="background:none; border:none; color:#ff4444; font-weight:900; font-size:0.7rem;">ОЧИСТИТЬ</button>
        </div>
        <div id="cartItems" style="margin-bottom:20px;"></div>
        <div style="display:flex; justify-content:space-between; font-weight:900; font-size:1.2rem; border-top:1px solid #333; padding-top:15px;">
            <span>ИТОГО:</span><span id="cartSum">0 ₽</span>
        </div>
        <button class="btn-buy" style="margin-top:20px;" onclick="checkout()">ОФОРМИТЬ В ТГ</button>
    </div>
</div>

<div class="overlay" id="adminOverlay" onclick="closeModal('adminOverlay')">
    <div class="modal glass" onclick="event.stopPropagation()">
        <h2 style="margin-bottom:20px;">АДМИН-ПАНЕЛЬ</h2>
        <button class="btn-variant" onclick="openConfig('products')">ТОВАРЫ</button>
        <button class="btn-variant" onclick="openConfig('wheel')">РУЛЕТКА (3 ТИРА)</button>
        <button class="btn-variant" onclick="openConfig('reqs')">РЕКВИЗИТЫ</button>
        <button class="admin-btn-red" onclick="logout()">ВЫЙТИ ИЗ АДМИНКИ</button>
    </div>
</div>

<div class="overlay" id="adminWheelOverlay" onclick="closeModal('adminWheelOverlay')">
    <div class="modal glass" onclick="event.stopPropagation()">
        <h3 id="twTitle">РЕДАКТОР РУЛЕТКИ</h3>
        <div id="wheelAdminItems" style="margin:15px 0;"></div>
        <button class="btn-variant" onclick="addWinItem()">+ ДОБАВИТЬ ПРИЗ</button>
        <button class="btn-buy" style="margin-top:15px;" onclick="saveWheelConfig()">СОХРАНИТЬ ТИР</button>
    </div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.ready(); tg.expand();

    const firebaseConfig = {
        apiKey: "AIzaSyD3wDw2ZTTXn2gY467grDOVi9E5vcusilc",
        authDomain: "alexsmok-1dc1c.firebaseapp.com",
        databaseURL: "https://alexsmok-1dc1c-default-rtdb.firebaseio.com",
        projectId: "alexsmok-1dc1c",
        appId: "1:173792761960:web:5bc84d324322edd58ac3dd"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    const userId = tg.initDataUnsafe?.user?.id || "test_user";
    const userRef = db.ref('users/' + userId);

    let products = [], cart = [], curCat = 'all', isAdmin = false;
    let wheelConfigs = { t10: [], t50: [], t150: [] }, curWheelTier = 10, isSpinning = false;
    let shopSettings = { bank_info: "Карта: 0000 0000..." };

    // Загрузка
    function init() {
        // Баланс
        userRef.on('value', s => {
            const d = s.val() || { balance: 0 };
            document.getElementById('hBal').innerText = (d.balance || 0) + ' ₽';
            document.getElementById('mBal').innerText = (d.balance || 0) + ' ₽';
        });
        // Товары
        db.ref('products').on('value', s => {
            products = s.val() ? Object.keys(s.val()).map(k => ({id:k, ...s.val()[k]})) : [];
            render();
        });
        // Настройки
        db.ref('settings').on('value', s => {
            const d = s.val();
            if(d) {
                if(d.wheel_v2) wheelConfigs = d.wheel_v2;
                if(d.bank_info) {
                    shopSettings.bank_info = d.bank_info;
                    document.getElementById('paymentDetails').innerText = d.bank_info;
                }
            }
        });
    }

    function render() {
        const cats = ['all', ...new Set(products.map(p => p.category))];
        document.getElementById('cats').innerHTML = cats.map(c => `<div class="cat-link glass ${curCat===c?'active':''}" onclick="curCat='${c}';render()">${c.toUpperCase()}</div>`).join('');
        
        const filtered = curCat === 'all' ? products : products.filter(p => p.category === curCat);
        let html = filtered.map(p => `
            <div class="card glass">
                <img src="${p.imageData}" class="card-img" onclick="${isAdmin ? `editProduct('${p.id}')` : ''}">
                <div class="card-info">
                    <div class="card-name">${p.name}</div>
                    <div class="card-price">${p.price} ₽</div>
                    ${p.variants ? `<button class="btn-variant" onclick="showVariants('${p.id}')">ВКУСЫ</button>` : `<button class="btn-buy" onclick="addToCart('${p.id}')">В КОРЗИНУ</button>`}
                </div>
            </div>`).join('');
        
        if(isAdmin) html += `<div class="card glass" style="border:2px dashed #444; height:220px; display:flex; align-items:center; justify-content:center;" onclick="addNewProduct()">+ ТОВАР</div>`;
        document.getElementById('grid').innerHTML = html;
    }

    // Кошелек
    window.payStars = async () => {
        try {
            const r = await fetch(`https://smokin-shop.vercel.app/api/getInvoice?userId=${userId}`);
            const d = await r.json();
            if(d.link) tg.openInvoice(d.link);
        } catch(e) { alert("Ошибка API"); }
    };

    window.confirmSBP = () => {
        const sum = prompt("Введите сумму которую оплатили:");
        if(sum) {
            db.ref('requests').push({ userId, user: tg.initDataUnsafe?.user?.username || 'Anon', sum, date: new Date().toLocaleString() });
            alert("Заявка отправлена. Скиньте скрин чека менеджеру!");
            tg.openTelegramLink("https://t.me/smokinshop174");
        }
    };

    // Рулетка (Оригинальная логика)
    window.setWheelTier = (t) => {
        curWheelTier = t;
        document.querySelectorAll('#wheelOverlay .cat-link').forEach(b => b.classList.remove('active'));
        document.getElementById('btn'+t).classList.add('active');
        document.getElementById('wheelRes').innerText = "";
        const track = document.getElementById('wheelTrack');
        track.style.transition = "none"; track.style.transform = "translateY(0)";
        const list = wheelConfigs['t'+t] || [{name: "Пусто"}];
        track.innerHTML = Array(60).fill(0).map((_, i) => `<div class="wheel-item">${list[i % list.length].name}</div>`).join('');
    };

    window.startSpin = () => {
        if(isSpinning) return;
        const bal = parseInt(document.getElementById('hBal').innerText);
        if(bal < curWheelTier && !isAdmin) return alert("Недостаточно баланса!");

        isSpinning = true;
        if(!isAdmin) userRef.child('balance').set(bal - curWheelTier);

        const track = document.getElementById('wheelTrack');
        const list = wheelConfigs['t'+curWheelTier];
        const winIdx = 45 + Math.floor(Math.random() * 10);
        const winPrize = list[winIdx % list.length].name;

        track.style.transition = "transform 4s cubic-bezier(0.15, 0, 0.15, 1)";
        track.style.transform = `translateY(-${winIdx * 150}px)`;

        setTimeout(() => {
            document.getElementById('wheelRes').innerHTML = `ВЫИГРЫШ: <span style="color:var(--neon-green)">${winPrize}</span>`;
            userRef.child('history').push({ prize: winPrize, date: new Date().toLocaleDateString() });
            isSpinning = false;
        }, 4100);
    };

    // Админка (Управление 3 тирами)
    window.openConfig = (type) => {
        if(type === 'wheel') {
            document.getElementById('twTitle').innerText = `РЕДАКТОР ТИРА ${curWheelTier} ₽`;
            const list = wheelConfigs['t'+curWheelTier] || [];
            document.getElementById('wheelAdminItems').innerHTML = list.map((it, i) => `
                <div style="display:flex; gap:5px; margin-bottom:5px;">
                    <input class="admin-inp" value="${it.name}" onchange="updateWinItem(${i}, this.value)" style="margin:0">
                    <button onclick="removeWinItem(${i})" style="background:red; border:none; padding:10px; border-radius:10px;">✕</button>
                </div>
            `).join('');
            openModal('adminWheelOverlay');
        }
        if(type === 'reqs') {
            const info = prompt("Введите новые реквизиты СБП:", shopSettings.bank_info);
            if(info) db.ref('settings/bank_info').set(info);
        }
    };

    window.addWinItem = () => { wheelConfigs['t'+curWheelTier].push({name:"Приз"}); openConfig('wheel'); };
    window.updateWinItem = (i, v) => wheelConfigs['t'+curWheelTier][i].name = v;
    window.removeWinItem = (i) => { wheelConfigs['t'+curWheelTier].splice(i, 1); openConfig('wheel'); };
    window.saveWheelConfig = () => { db.ref('settings/wheel_v2').set(wheelConfigs); closeModal('adminWheelOverlay'); };

    window.logout = () => { isAdmin = false; render(); closeModal('adminOverlay'); document.getElementById('adminLock').style.color = '#fff'; };
    
    // Корзина
    window.addToCart = (id) => {
        const p = products.find(x => x.id === id);
        cart.push({ name: p.name, price: p.price });
        updateCart();
        tg.HapticFeedback.impactOccurred('light');
    };
    window.clearCart = () => { cart = []; updateCart(); closeModal('cartOverlay'); };
    function updateCart() {
        const count = cart.length;
        document.getElementById('cartFab').style.display = count > 0 ? 'flex' : 'none';
        document.getElementById('cartCount').innerText = count;
        let sum = 0;
        document.getElementById('cartItems').innerHTML = cart.map(i => {
            sum += parseInt(i.price);
            return `<div style="display:flex; justify-content:space-between; margin-bottom:10px;"><span>${i.name}</span><b>${i.price} ₽</b></div>`;
        }).join('');
        document.getElementById('cartSum').innerText = sum + ' ₽';
    }

    // База
    window.adminAuth = () => {
        if(isAdmin) return openModal('adminOverlay');
        if(prompt("Пароль:") === 'smkn174') {
            isAdmin = true; render(); document.getElementById('adminLock').style.color = 'var(--neon-green)';
        }
    };

    window.openModal = (id) => { document.getElementById(id).style.display = 'flex'; setTimeout(()=>document.getElementById(id).classList.add('active'), 10); };
    window.closeModal = (id) => { document.getElementById(id).classList.remove('active'); setTimeout(()=>document.getElementById(id).style.display='none', 300); };

    // Фон
    const canvas = document.getElementById('bg-canvas');
    const ctx = canvas.getContext('2d');
    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    window.onresize = resize; resize();
    function draw() { ctx.fillStyle='rgba(0,0,0,0.1)'; ctx.fillRect(0,0,canvas.width,canvas.height); requestAnimationFrame(draw); }
    draw();

    init();
    setWheelTier(10);
</script>
</body>
</html>
